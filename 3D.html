<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>6Ã—6 å¯æ‹–å‹•åº§ä½è¡¨ï¼ˆFirebase åŒæ­¥ç‰ˆ - æ€§åˆ¥é…è‰²ï¼‰</title>
    
    <style>
        body {margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"PingFang HK","Microsoft JhengHei";background:#111827;color:#e5e7eb;text-align:center;}
        h1 {font-size:20px;margin:20px 0;}
        #rows {display:flex;flex-direction:column-reverse;align-items:center;gap:10px;margin-bottom:20px;}
        .row {display:grid;grid-template-columns:repeat(6,150px);gap:8px;}
        .seat {height:70px;width:150px;background:#1e293b;border-radius:6px;display:flex;align-items:center;justify-content:center;border:1px solid #334155;cursor:pointer;}
        .seat:hover {background:#0ea5e9;}
        .student {user-select:none;cursor:grab;font-weight:600;}
        .toolbar {margin-bottom:20px;}
        button {cursor:pointer;border:none;padding:8px 14px;border-radius:8px;font-weight:600;color:#fff;background:#16a34a;margin:0 4px;}
        button.danger{background:#dc2626;}
        #bank {display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin-bottom:20px;}
        
        /* ---------------------------------------------------- */
        /* æ–°å¢ï¼šæ€§åˆ¥é…è‰²æ¨£å¼ */
        /* ---------------------------------------------------- */
        
        /* ç”·åŒå­¸ï¼šæ·¡ç²‰è—è‰² (Light Pastel Blue) */
        .student.male {
            background:#3b82f6; /* åŸä¾†çš„æ·±è—è‰² */
            background:#93c5fd; /* è¼ƒæ·¡çš„ç²‰è—è‰² */
            color: #1e3a8a; /* æ·±è‰²æ–‡å­—ä»¥ç¢ºä¿å¯è®€æ€§ */
        }

        /* å¥³åŒå­¸ï¼šæ·¡ç²‰è‰² (Light Pastel Pink) */
        .student.female {
            background:#f472b6; /* è¼ƒæ·±çš„ç²‰è‰² */
            background:#fbcfe8; /* è¼ƒæ·¡çš„ç²‰è‰² */
            color: #831843; /* æ·±è‰²æ–‡å­—ä»¥ç¢ºä¿å¯è®€æ€§ */
        }

        #bank .student {
             /* æ ¹æ“šæ€§åˆ¥æ‡‰ç”¨é¡è‰² */
            padding:4px 8px;border-radius:6px;
        }
        
        /* ç¢ºä¿æœªå…¥åº§åˆ—è¡¨çš„å­¸ç”Ÿé¡è‰²ä¹Ÿæ‡‰ç”¨äº†æ€§åˆ¥è‰² */
        #bank .student.male {
             background:#93c5fd; 
        }
        #bank .student.female {
             background:#fbcfe8;
        }

        .foot {font-size:12px;color:#9ca3af;margin-bottom:20px;}
    </style>
</head>
<body>
    <h1>6Ã—6 å¯æ‹–å‹•åº§ä½è¡¨ï¼ˆé•·æ–¹å½¢æ ¼ï¼Œæ•™å¸«æ¡Œåœ¨ä¸‹æ–¹ï¼‰</h1>
    <div class="toolbar">
        <button id="btnShuffle">éš¨æ©Ÿç·¨æ’</button>
        <button id="btnClear" class="danger">æ¸…ç©º</button>
    </div>
    <div id="rows"></div>
    <div class="foot">ğŸ§­ ä¸‹æ–¹ç‚ºæ•™å¸«æ¡Œå‰æ’</div>
    <h3>æœªå…¥åº§åå–®</h3>
    <div id="bank"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // ----------------------------------------------------
        // æ‚¨çš„ Firebase é…ç½®è³‡è¨Š (ä¿æŒä¸è®Š)
        // ----------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyANB5cwFX9LCmWjQVfHL7CIEAf_Pz-Tvow",
            authDomain: "seating-plan-1ef04.firebaseapp.com",
            projectId: "seating-plan-1ef04",
            storageBucket: "seating-plan-1ef04.firebasestorage.app",
            messagingSenderId: "167415270734",
            appId: "1:167415270734:web:26cf01a38864b6213f621f"
        };

        // åˆå§‹åŒ– Firebase å’Œ Firestore
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const SEAT_DOC_REF = db.collection("seating_charts").doc("class_a_seats");
        
        // ----------------------------------------------------
        // é—œéµä¿®æ”¹ 1ï¼šä¿®æ”¹ NAMES è®Šæ•¸ï¼Œå°‡å­¸ç”Ÿè³‡æ–™è½‰ç‚ºç‰©ä»¶é™£åˆ—ï¼ŒåŒ…å«æ€§åˆ¥è³‡è¨Š
        // ----------------------------------------------------
        
        const MALE_NAMES = [
             "é™³æµ©è»’", "é™³æ ¢æ¿¤", "é™³æº¢ç¦®", "å¼µç©é›‹", "è¦ƒå½¥éœ–", "å´”å‡Œå³°",
             "ä½•æ¾¤ä»", "åŠ‰æ˜Šè»’", "ææ–‡éŸœ", "ææŸç†¹", "æ¢æ·½ç«£", "æä¸–è°",
             "æ—å¸Œ", "è«å®¶æ˜‡", "å³é–å˜‰", "å½­å¯¶èª ", "ç‹å­é½Š", "è¶™ä¿Šå ¯"
        ];
        const FEMALE_NAMES = [
             "é™³æ˜è”š", "é™³å½¥éœ", "å¼µè·¯éœ", "éŸ“æŸ³è±", "é»ƒè““æ©", "é»æ´›å®œ",
             "æ—è‡³å¦", "åŠ‰å®¹æ…§", "æç©è©©", "æå˜‰å½¤", "é¦¬ä¸¹æ•", "è«å€šæ•",
             "ç‹ç§‹å©·", "ä¼å‡±ç‘¤", "é¾æ±ç¿¹"
        ];
        
        // åˆä½µç‚ºå–®ä¸€åˆ—è¡¨ï¼Œæ¯å€‹å…ƒç´ æ˜¯ä¸€å€‹åŒ…å« name å’Œ gender çš„ç‰©ä»¶
        const ALL_STUDENTS = [
             ...MALE_NAMES.map(name => ({ name: name, gender: 'male' })),
             ...FEMALE_NAMES.map(name => ({ name: name, gender: 'female' }))
        ];
        
        // NAMES è®Šæ•¸ç¾åœ¨å°‡ç”¨æ–¼æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦åœ¨ ALL_STUDENTS ä¸­
        const NAMES = ALL_STUDENTS.map(s => s.name); 

        const ROWS=6,COLS=6,TOTAL=ROWS*COLS;
        // seats é™£åˆ—ç¾åœ¨å°‡å„²å­˜å­¸ç”Ÿç‰©ä»¶ (ä¾‹å¦‚ï¼š{name: 'é™³æµ©è»’', gender: 'male'})
        let seats=new Array(TOTAL).fill(null),selected=null; 
        const rowsEl=document.getElementById('rows'),bankEl=document.getElementById('bank');

        function build(){rowsEl.innerHTML='';let i=0;for(let r=0;r<ROWS;r++){const row=document.createElement('div');row.className='row';for(let c=0;c<COLS;c++){const seat=document.createElement('div');seat.className='seat';seat.dataset.i=i;seat.addEventListener('click',clickSeat);seat.addEventListener('dragover',e=>e.preventDefault());seat.addEventListener('drop',dropSeat);row.appendChild(seat);i++;}rowsEl.appendChild(row);}render();}

        // ----------------------------------------------------
        // é—œéµä¿®æ”¹ 2ï¼šä¿®æ”¹ render() å‡½æ•¸ï¼Œè™•ç†ç‰©ä»¶è³‡æ–™ä¸¦æ·»åŠ æ€§åˆ¥ CSS Class
        // ----------------------------------------------------
        function render(){
            // è™•ç†åº§ä½è¡¨
            document.querySelectorAll('.seat').forEach(s=>{
                s.innerHTML='';
                const i=+s.dataset.i;
                if(seats[i]){
                    const studentData = seats[i]; // seats[i] æ˜¯ä¸€å€‹ç‰©ä»¶
                    const t=document.createElement('div');
                    t.className='student ' + studentData.gender; // æ·»åŠ æ€§åˆ¥ class
                    t.textContent=studentData.name;
                    t.draggable=true;
                    // æ‹–æ›³æ•¸æ“šç¾åœ¨åŒ…å« name å’Œ gender
                    t.addEventListener('dragstart',e=>{
                        e.dataTransfer.setData('text',JSON.stringify({name:studentData.name, gender: studentData.gender, i}));
                    });
                    s.appendChild(t);
                }
            });
            
            // è™•ç†æœªå…¥åº§åå–® (Bank)
            bankEl.innerHTML='';
            
            // éæ¿¾å‡ºæœªå…¥åº§çš„å­¸ç”Ÿç‰©ä»¶
            const currentSeatedNames = seats.filter(s => s !== null).map(s => s.name);
            const remainingStudents = ALL_STUDENTS.filter(s => !currentSeatedNames.includes(s.name));
            
            remainingStudents.forEach(studentData=>{
                const t=document.createElement('div');
                t.className='student ' + studentData.gender; // æ·»åŠ æ€§åˆ¥ class
                t.textContent=studentData.name;
                t.draggable=true;
                // æ‹–æ›³æ•¸æ“šåŒ…å« name å’Œ gender
                t.addEventListener('dragstart',e=>{
                    e.dataTransfer.setData('text',JSON.stringify({name:studentData.name, gender: studentData.gender}));
                });
                bankEl.appendChild(t);
            });
            bankEl.addEventListener('dragover',e=>e.preventDefault());
            bankEl.addEventListener('drop',dropBank);
        }

        // ----------------------------------------------------
        // é—œéµä¿®æ”¹ 3ï¼šä¿®æ”¹æ‹–æ›³/é»æ“Šå‡½æ•¸ï¼Œè™•ç†ç‰©ä»¶è³‡æ–™çš„äº¤æ›å’Œè³¦å€¼
        // ----------------------------------------------------
        
        function clickSeat(e){
            const idx=+e.currentTarget.dataset.i;
            if(selected===null){
                selected=idx;
                e.currentTarget.style.outline='2px solid #22c55e';
            }else{
                const a=selected,b=idx;
                document.querySelector(`.seat[data-i="${a}"]`).style.outline='none';
                // äº¤æ› seats é™£åˆ—ä¸­çš„ç‰©ä»¶
                [seats[a],seats[b]]=[seats[b],seats[a]];
                selected=null;
                render();
                save();
            }
        }

        function dropSeat(e){
            e.preventDefault();
            const data=JSON.parse(e.dataTransfer.getData('text'));
            const idx=+e.currentTarget.dataset.i;
            
            // å‰µå»ºæˆ–æ¥æ”¶å­¸ç”Ÿç‰©ä»¶
            const studentObject = {name: data.name, gender: data.gender};

            if(data.i!=null){
                // ä¾†è‡ªåº§ä½è¡¨çš„æ‹–æ›³ (äº¤æ›)
                [seats[data.i],seats[idx]]=[seats[idx],seats[data.i]];
            }else{
                // ä¾†è‡ªæœªå…¥åº§åå–®çš„æ‹–æ›³ (æ”¾ç½®)
                seats[idx]=studentObject;
            }
            render();
            save();
        }
        
        function dropBank(e){
            e.preventDefault();
            const data=JSON.parse(e.dataTransfer.getData('text'));
            if(data.i!=null){
                // å°‡åº§ä½ä¸Šçš„å­¸ç”Ÿè¨­ç‚º null
                seats[data.i]=null;
                render();
                save();
            }
        }

        function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
        
        // éš¨æ©Ÿåˆ†é…å‡½æ•¸ï¼Œç¾åœ¨è™•ç†å­¸ç”Ÿç‰©ä»¶
        function randomAssign(){
            seats.fill(null);
            shuffle([...ALL_STUDENTS]).forEach((studentObject,i)=>{
                if(i<TOTAL)seats[i]=studentObject; // å„²å­˜ç‰©ä»¶
            });
            render();
            save(); 
        }
        
        function clearAll(){
            seats.fill(null);
            render();
            save(); 
        }

        // ----------------------------------------------------
        // Firebase é‚è¼¯ (ä¿æŒä¸è®Š)
        // ----------------------------------------------------
        
        function save(){
            SEAT_DOC_REF.set({ seats: seats })
                .then(() => {
                    console.log("åº§ä½è¡¨å·²åŒæ­¥å„²å­˜åˆ°é›²ç«¯ã€‚");
                })
                .catch((error) => {
                    console.error("å„²å­˜å¤±æ•—:", error);
                });
        }
        
        function listenForUpdates() {
            SEAT_DOC_REF.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data && data.seats && JSON.stringify(data.seats) !== JSON.stringify(seats)) {
                        seats = data.seats;
                        render();
                        console.log("åº§ä½è¡¨å·²å¾é›²ç«¯å³æ™‚æ›´æ–°ã€‚");
                    }
                } else {
                    console.log("é›²ç«¯åº§ä½è¡¨æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°‡åŸ·è¡Œåˆå§‹éš¨æ©Ÿåˆ†é…ã€‚");
                    randomAssign(); 
                }
            });
        }

        // æ‡‰ç”¨å•Ÿå‹•
        document.getElementById('btnShuffle').addEventListener('click',randomAssign);
        document.getElementById('btnClear').addEventListener('click',clearAll);

        function initApp() {
            build();
            listenForUpdates(); 
        }

        initApp();
    </script>
</body>
</html>
