<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>6Ã—6 å¯æ‹–å‹•åº§ä½è¡¨ï¼ˆFirebase åŒæ­¥ç‰ˆï¼‰</title>
    
    <style>
        body {margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"PingFang HK","Microsoft JhengHei";background:#111827;color:#e5e7eb;text-align:center;}
        h1 {font-size:20px;margin:20px 0;}
        #rows {display:flex;flex-direction:column-reverse;align-items:center;gap:10px;margin-bottom:20px;}
        .row {display:grid;grid-template-columns:repeat(6,150px);gap:8px;}
        .seat {height:70px;width:150px;background:#1e293b;border-radius:6px;display:flex;align-items:center;justify-content:center;border:1px solid #334155;cursor:pointer;}
        .seat:hover {background:#0ea5e9;}
        .student {user-select:none;cursor:grab;font-weight:600;}
        .toolbar {margin-bottom:20px;}
        button {cursor:pointer;border:none;padding:8px 14px;border-radius:8px;font-weight:600;color:#fff;background:#16a34a;margin:0 4px;}
        button.danger{background:#dc2626;}
        #bank {display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin-bottom:20px;}
        #bank .student {background:#1e3a8a;padding:4px 8px;border-radius:6px;}
        .foot {font-size:12px;color:#9ca3af;margin-bottom:20px;}
    </style>
</head>
<body>
    <h1>6Ã—6 å¯æ‹–å‹•åº§ä½è¡¨ï¼ˆé•·æ–¹å½¢æ ¼ï¼Œæ•™å¸«æ¡Œåœ¨ä¸‹æ–¹ï¼‰</h1>
    <div class="toolbar">
        <button id="btnShuffle">éš¨æ©Ÿç·¨æ’</button>
        <button id="btnClear" class="danger">æ¸…ç©º</button>
    </div>
    <div id="rows"></div>
    <div class="foot">ğŸ§­ ä¸‹æ–¹ç‚ºæ•™å¸«æ¡Œå‰æ’</div>
    <h3>æœªå…¥åº§åå–®</h3>
    <div id="bank"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // ----------------------------------------------------
        // æ‚¨çš„ Firebase é…ç½®è³‡è¨Š
        // ----------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyANB5cwFX9LCmWjQVfHL7CIEAf_Pz-Tvow",
            authDomain: "seating-plan-1ef04.firebaseapp.com",
            projectId: "seating-plan-1ef04",
            storageBucket: "seating-plan-1ef04.firebasestorage.app",
            messagingSenderId: "167415270734",
            appId: "1:167415270734:web:26cf01a38864b6213f621f"
        };

        // åˆå§‹åŒ– Firebase å’Œ Firestore
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // æŒ‡å®šåº§ä½è¡¨è³‡æ–™å„²å­˜çš„ä½ç½® (æ–‡æª” ID: class_a_seats)
        const SEAT_DOC_REF = db.collection("seating_charts").doc("class_a_seats");
        
        // ----------------------------------------------------
        // æ‚¨çš„åŸæœ‰ç¨‹å¼ç¢¼é‚è¼¯
        // ----------------------------------------------------
        const NAMES=["é™³æµ©è»’","é™³æ ¢æ¿¤","é™³æº¢ç¦®","å¼µç©é›‹","è¦ƒå½¥éœ–","å´”å‡Œå³°","ä½•æ¾¤ä»","åŠ‰æ˜Šè»’","ææ–‡éŸœ","ææŸç†¹","æ¢æ·½ç«£","æä¸–è°","æ—å¸Œ","è«å®¶æ˜‡","å³é–å˜‰","å½­å¯¶èª ","ç‹å­é½Š","è¶™ä¿Šå ¯","é™³æ˜è”š","é™³å½¥éœ","å¼µè·¯éœ","éŸ“æŸ³è±","é»ƒè““æ©","é»æ´›å®œ","æ—è‡³å¦","åŠ‰å®¹æ…§","æç©è©©","æå˜‰å½¤","é¦¬ä¸¹æ•","è«å€šæ•","ç‹ç§‹å©·","ä¼å‡±ç‘¤","é¾æ±ç¿¹"];
        const ROWS=6,COLS=6,TOTAL=ROWS*COLS;
        let seats=new Array(TOTAL).fill(null),selected=null;
        const rowsEl=document.getElementById('rows'),bankEl=document.getElementById('bank');

        function build(){rowsEl.innerHTML='';let i=0;for(let r=0;r<ROWS;r++){const row=document.createElement('div');row.className='row';for(let c=0;c<COLS;c++){const seat=document.createElement('div');seat.className='seat';seat.dataset.i=i;seat.addEventListener('click',clickSeat);seat.addEventListener('dragover',e=>e.preventDefault());seat.addEventListener('drop',dropSeat);row.appendChild(seat);i++;}rowsEl.appendChild(row);}render();}

        function render(){document.querySelectorAll('.seat').forEach(s=>{s.innerHTML='';const i=+s.dataset.i;if(seats[i]){const t=document.createElement('div');t.className='student';t.textContent=seats[i];t.draggable=true;t.addEventListener('dragstart',e=>{e.dataTransfer.setData('text',JSON.stringify({name:seats[i],i}));});s.appendChild(t);}});
        bankEl.innerHTML='';const remaining=NAMES.filter(n=>!seats.includes(n));remaining.forEach(n=>{const t=document.createElement('div');t.className='student';t.textContent=n;t.draggable=true;t.addEventListener('dragstart',e=>{e.dataTransfer.setData('text',JSON.stringify({name:n}));});bankEl.appendChild(t);});bankEl.addEventListener('dragover',e=>e.preventDefault());bankEl.addEventListener('drop',dropBank);}

        function clickSeat(e){const idx=+e.currentTarget.dataset.i;if(selected===null){selected=idx;e.currentTarget.style.outline='2px solid #22c55e';}else{const a=selected,b=idx;document.querySelector(`.seat[data-i="${a}"]`).style.outline='none';[seats[a],seats[b]]=[seats[b],seats[a]];selected=null;render();save();}}

        function dropSeat(e){e.preventDefault();const data=JSON.parse(e.dataTransfer.getData('text'));const idx=+e.currentTarget.dataset.i;if(data.i!=null){[seats[data.i],seats[idx]]=[seats[idx],seats[data.i]];}else{seats[idx]=data.name;}render();save();}
        function dropBank(e){e.preventDefault();const data=JSON.parse(e.dataTransfer.getData('text'));if(data.i!=null){seats[data.i]=null;render();save();}}

        function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
        
        // ----------------------------------------------------
        // é—œéµä¿®æ”¹ï¼šä½¿ç”¨ Firebase å¯¦ç¾å„²å­˜èˆ‡åŒæ­¥
        // ----------------------------------------------------
        
        function save(){
            // å°‡åº§ä½é™£åˆ—å„²å­˜åˆ° Firestore
            SEAT_DOC_REF.set({ seats: seats })
                .then(() => {
                    console.log("åº§ä½è¡¨å·²åŒæ­¥å„²å­˜åˆ°é›²ç«¯ã€‚");
                })
                .catch((error) => {
                    console.error("å„²å­˜å¤±æ•—:", error);
                });
        }
        
        function randomAssign(){
            // éš¨æ©Ÿåˆ†é…å¾Œï¼ŒåŸ·è¡Œå„²å­˜ä»¥åŒæ­¥åˆ°é›²ç«¯
            seats.fill(null);
            shuffle([...NAMES]).forEach((n,i)=>{if(i<TOTAL)seats[i]=n});
            render();
            save(); 
        }
        
        function clearAll(){
            // æ¸…ç©ºå¾Œï¼ŒåŸ·è¡Œå„²å­˜ä»¥åŒæ­¥åˆ°é›²ç«¯
            seats.fill(null);
            render();
            save(); 
        }

        // å¯¦ä½œå³æ™‚ç›£è½ (Live Synchronization)
        function listenForUpdates() {
            SEAT_DOC_REF.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    // æª¢æŸ¥é›²ç«¯è³‡æ–™æ˜¯å¦å­˜åœ¨ä¸”èˆ‡æœ¬åœ°è³‡æ–™ä¸åŒï¼Œé˜²æ­¢ç„¡é™æ›´æ–°è¿´åœˆ
                    if (data && data.seats && JSON.stringify(data.seats) !== JSON.stringify(seats)) {
                        seats = data.seats;
                        render();
                        console.log("åº§ä½è¡¨å·²å¾é›²ç«¯å³æ™‚æ›´æ–°ã€‚");
                    }
                } else {
                    // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ (ç¬¬ä¸€æ¬¡é‹è¡Œ)ï¼Œå‰‡åŸ·è¡Œéš¨æ©Ÿåˆ†é…ä¸¦å„²å­˜
                    console.log("é›²ç«¯åº§ä½è¡¨æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°‡åŸ·è¡Œåˆå§‹éš¨æ©Ÿåˆ†é…ã€‚");
                    randomAssign(); 
                }
            });
        }

        // ----------------------------------------------------
        // æ‡‰ç”¨å•Ÿå‹•
        // ----------------------------------------------------
        
        document.getElementById('btnShuffle').addEventListener('click',randomAssign);
        document.getElementById('btnClear').addEventListener('click',clearAll);

        function initApp() {
            build();
            // å•Ÿå‹•å³æ™‚ç›£è½ï¼Œå–ä»£èˆŠçš„ load()
            listenForUpdates(); 
        }

        initApp();
    </script>
</body>
</html>
